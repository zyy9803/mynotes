[前端需要了解的计算机网络知识， 这一篇就够了！](https://juejin.cn/post/6844904079974465544)

## 性能指标

这些内容主要是为了学习后面具体的协议，以及分析这些协议的报文时，需要掌握的基本概念。

### 速率

速率就是数据传输（数据是指0和1）的速率，比如你用迅雷下载，1兆每秒，来衡量目前数据传输的快慢。它是计算机网络中最重要的一个性能指标。

### 带宽

在计算机网络中，网络带宽是指在单位时间（一般指的是1秒钟）内能传输的数据量，比如说你家的电信网络是100兆比特，意思是，一秒内最大的传输速率是100兆比特。

### 吞吐量

吞吐量表示在单位时间内通过某个网络（或信道、接口）的数据量。

以上三点，我们举个案例

- 一条路每秒最多能过100辆车（宽带就相当于100辆/秒）。
- 而并不是每秒都会有100辆车过，假如第一秒有0辆，第二秒有10辆...，（但是最多不能超过100辆）。
- 所以有第1秒0辆/秒，第2秒10辆/秒，第3秒30辆/秒，这不能说带宽多少吧，于是就用吞吐量表示具体时间通过的量有多少（也有可能等于带宽的量）。
- 由此可知带宽是说的是最大值速率，吞吐量说的是某时刻速率。但吞吐量不能超过最大速率。

### 时延

时延是指数据（报文/分组/比特流）从网络（或链路）的一端传送到另一端所需的时间。单位是s。 时延分一下几种：

（1）发送时延

就是说我跟你说话，从我开始说，到说话结束这段时间，就是`发送时延`。

（2）传播时延

信道上第一个比特开始，到最后一个比特达到主机接口需要的时间就是`传播时延`。

（3）排队时延

- 分组在经过网络传输时，要经过很多的`路由器`。
- 但分组在进入路由器后要先在输入队列中`排队等待`处理。
- 在路由器确定了转发接口后，还要在输出队列中排队等待转发，这就产生了`排队时延`。
- 排队时延的长短往往却决于网络当时的通信量，当网络的通信量很大时会发生排队溢出，是`分组丢失`。

（4）处理时延

`路由器`或`主机`在收到数据包时，要花费一定时间进行处理，例如`分析数据包的首部`、进行`首部差错检验`，`查找路由表`为数据包选定准发接口，这就产生了`处理时延`。

（5）往返时间（RTT）

在计算机网络中，往返时间也是一个重要的性能指标，它表示从发送方发送数据开始，到发送方收到来自接收方的确认（接受方收到数据后便立即发送确认）`总共经历的时间`

（6）时延带宽积

是指传播时延乘以带宽







## 物理层

**功能：**在物理媒体上为数据端设备透明地传递原始比特流。传输单位是比特。

- 比如说，规定了`电气特性`，信号的电平用`+10V - +15V`表示二进制的`0`，用`-10V - -15V`表示二进制的`1`，只要条网线能表示这个特性，就不管你用什么材料了。
- 当然还有其它特性，我们不需要了解，`知道物理层是规定传输媒体接口的标准`即可。



### 光纤数据传输形式

* 首先计算机`网卡`传输出来的数据是`电信号`，`光纤`传输的是`光脉冲`信号，有光脉冲表示`1`，无光脉冲表示`0`。
* 而可见光的频率大约是`10的8次方MHz`，因此光纤通信系统的带宽远远大于其它各种传输媒体的带宽
* 所以我们计算机传输数据需要先把`电信号`转为`光信号`，然后`光信号`快到服务器的时候，再把`光信号`转为`电信号`。



### 设备中继器

中继器可以对信号进行`再生`和`还原`，增加信号的传输距离。

需要注意的是，中继器两端连接`不同的网段`，而不是子网。什么叫不同的网段呢，需要在网络层学习`IP分类`之后才能够理解这个概念，这里简单的理解为，不同的网段就是`不同路由器连接的网络`。







## 数据链路层

**链路**就是从一个**结点到相邻结点**的一段物理线路，而中间没有任何其他的交换结点

**数据链路**是指把实现通信协议的硬件和软件加到链路上，就构成了数据链路

**功能：**在**点对点之间**建立数据链路连接，把实现通信协议的硬件和软件加到链路上，详细解释如下

**协议：**

* CSMA/CD：协调多个发送和接受站点对一个共享传输媒体的占用



### 主要功能

* 封装成帧：数据链路层并不是无脑转发boss的信息，她要把文件编号封装一下。封装的网络数据包，在链路层就叫`数据帧`。

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7045e4e203c7421bbff11f2036e059f6~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

* 透明传输：是指不管boss下达的任何信息，比如文件里有裁掉这个秘书的信息，秘书都要原原本本的传输。帧的数据部分可能有`跟帧首部完全一样`的字符，这时候就要采取一定的措施，让接受方不要被被误导，能让接收方知道哪些是帧的首部哪些是帧的数据。这个问题有没有类似js的转义字符的问题，比如字符串<div>到底是指div标签呢，还是div字符串呢？

* 差错控制：是在文件送到B公司小秘书手里的时候，快递包上写着5个文件，秘书一看只有3个文件，就会让傻子重新发送有没有送到的文件。差错控制的方法有`CRC循环冗余码`，这个就不细讲了，我自己也不甚了解，只知道链路层的帧，会有一个FCS位留给这个码，用来判断一个帧是否出错。

* 差错纠正：是链路层知道1，2，3，4，5个文件，丢失的两个文件到底是哪两个，并且能通过重新发送没有的文件来纠正。

* 流量控制：比如说`发送方发送速度特别快，接收方接收速度特别慢`，会造成传输出错。这里需要注意的是，传输层`TCP`也有`流量控制`功能，区别在于`TCP`是`端到端`的流量控制，链路层是`点到点`（比如一个路由器到下一个路由器）。流量控制的方法有`滑动窗口协议`，以及`选择重传协议`，这两个留在讲TCP的时候讲。接下来讲一下以太网，以太网是目前最常见的局域网技术。对于我们理解局域网比较有帮助。



### 以太网

以太网是一种`局域网`技术，其规定了`访问控制方法`、`传输控制协议`、`网络拓扑结构`、`传输速率`等，完成数据链路层和物理层的一些内容，它采用一种称作`CSMA/CD`的媒体接入方法（后面会介绍），另外的一些局域网技术，比如`无线局域网`等。



### 以太网帧格式

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f68b3989f6a14b9d9dc1aea808030970~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

- 其中`目的地址`和`源地址`指的是`MAC地址`，即设备的物理地址。MAC地址用于标示网卡，每个网卡都具有唯一的MAC 地址
- 当在同一个局域网中，主机A需要给主机B发送消息时，主机A将`以太网帧`发出，此时局域网中所有主机均可收到这个桢，主机中的网卡接收到以太网桢后，会将目的MAC地址和自己的MAC地址进行比较,`如果不相同就会丢弃，如果相同则会接收`，此时则Ｂ主机就收到了Ａ的消息。
- 其最后面是CRC循环冗余码，用于`差错控制`，即检验`帧的正确性`
- 在以太网协议中，目的地址分为三种`单播地址`、`广播地址`、`多播地址`，其中单播地址如上面Ａ给Ｂ主机发送，其接收者为一个，并且其目的地址的最高字节的低位为`０`



### 网卡

计算机传出的数据，经过网卡，就会变为`以太网的帧`，还会完成一些`链路管理`（CDMA/CD的实现），以及`编码和译码`



### CSMA/CD 协议

- 每一个站在发送数据之前以及发送数据时都要检测一下总线上是否有其他计算机在发送数据。
- 是`总线型`，`半双工网络`（半双工是指允许数据在两个方向上传输,但是,在某一时刻,只允许数据在一个方向上传输）
  - 对于共享信道，要考虑如何协调多个发送和接受站点对一个共享传输媒体的占用，即为媒体接入控制。




### 链路层的设备

* 网桥：根据`MAC帧`的目的地址进行转发和过滤。当网桥收到一个帧时，并不会向所有接口转发此帧，而是先检查此帧的目的`MAC地址`，然后再确定将该帧转发到哪一个口，或者是把它丢弃。

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c1d1ce4ecdee47689b52709bc49d57af~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

这里需要注意的是，网桥连接的是不同的网段，网段是什么呢，我这里简单介绍一下，具体要到讲`IP地址`的时候细说，同一网段指的是`IP地址`和`子网掩码`(讲ip地址的时候会细讲)相与得到相同的网络地址。

* 以太网交换机：谈到交换机，就不得不提两个概念，`冲突域`和`广播域`

  - 冲突域： 是指同一时间`只能由一台设备`发送信息的范围。

  - 广播域：如果站点发出一个广播信号，`所有能接收到这个信号`的设备范围称为广播域 

  - 也就是说，广播域可以`跨网段`，而冲突域只是发生的`同一个网段`。

举个例子，公司里大家的电脑一般都是连接到`交换机`上，因为交换机可以`隔离冲突域`，`冲突域`的最大问题在于，同一时间只能有一台机器传输数据，公司那么多人，如果这样的话，传输数据速度太慢了。然后交换机再连接到`路由器`上，首先`路由器`能隔离广播域`，其次不经过路由器，你的数据链路层上的包`没办法进入到互联网里面去，路由器是网络层的设备。







## 网络层

**功能：**将网络层的协议数据单元（分组）从源端传到目的端，提供**主机到主机之间的**通信服务。对分组进行路由选择，并实现流量控制、阻塞控制、差错控制和国际互联等功能。传输单位是数据报。



### 概念

#### 分组交换

当`主机H1`要向另一`主机H2`发送数据（报文）时，首先将数据划分成若干个`等长的分组`，然后将这些分组一个接一个地发往里与H1相联的`路由A` ,当`A`接到分组后，先放入缓冲区，再按一定的路由算法确定该分组下一步将发注哪个结点，如此一个结点一个结点传递，直到`最终目的H2`。

#### 数据报

数据报是通过网络传输的`数据的基本单元`，包含一个`报头（header）`和`数据`本身。说白了，就是带地址的数据，比如你的写了一句微信"你好"，这串文字本上加上源地址，目的地址，就是数据报。

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/353453144bb24d31a6be21cd405d25b4~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp" alt="img" style="zoom: 33%;" />

- 首部的固定部分是`20字节`，共20 * 8 = 160比特（1字节=8比特）
- `0 - 4 `比特是`版本号`，版本有ipv4/ipv6
- 首部长度，`单位是4B`，最小为5, 为什么是5呢？因为首部至少20字节，所以4* 5就是20字节
- 区分服务不用看。
- 总长度是，`首部+数据`
- 生存时间是`TTL`，它告诉网络，数据包在网络中的时间是否太长而应被丢弃。每经过一个路由器减一，变成0就丢弃
- 协议是指数据部分用的什么协议，我们只需要知道`TCP`协议用`6`表示，`UDP`协议用`17`表示即可。
- `首部校验和占16位`。这个字段只检验数据报的首部，但不包括数据部分。
- 目的地址和源地址都是`IP地址`，目的地址是通过`DNS`查询得来的。

#### IP 分片

链路层数据帧封装的`数据大小是有限制`的，以太网的`MTU`（MTU是指一种通信协议的某一层上面所能通过的最大数据包大小）是`1500字节`。

接下来我们就看看在ip数据包上，哪些字段标识了分片的数据呢？

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/25151dc392c04b12b88cf12ffe1d8772~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

- 标识是在`同一数据的分片`时相同。
- 标志占3位，但只有两位有意义，第一个位叫`MF`，`MF=1`即表示后面“还有分片”的数据报。`MF=0`表示这已是若干数据报片中的最后一个。
- 标志字段中间的一位记为`DF`(Don’t Fragment)，意思是“不能分片”。只有当`DF=0`时才允许分片。
- 片偏移，较长的分组在分片后，某片在原分组中的相对位置。

#### IP 地址分类

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eae5bc33ce124806a35270a7cc5da342~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) ip地址有5种

- A类：`1.0.0.0~126.255.255.255`
- B类：`128.0.0.0~191.255.255.255`
- C类：`192.0.0.0~223.255.255.255`
- D类：`224.0.0.0~239.255.255.255`
- E类：`240.0.0.0~254.255.255.255`
- 其中`127.0.0.0~127.255.255.255`用于环回测试，D类地址用于组播，E类地址用于科研

这里需要注意的是，你发没发现，为什么我们前端启动webpack测试环境的时候，一般地址都是192.168.*\*.\**(* 是指0-255的数字); 在公司和家里都是这个网段，不是很奇怪吗，你家里的网段怎么和公司一样呢？

其实是因为有一部分叫`私有IP地址`，是不能拿到网络上跟别的计算机通信的。`只能是局域网`自己内部用。比如说有：

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3525a6cbbcff407d88cd6c40e8761cfd~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

可以看到，C类私有地址就是192.168网段，每个局域网都可以有这些私有IP。

#### 网络地址转换

在ip地址分类里面，我们知道`私有ip地址`是不能跟外网交互的，在小公司大多数计算机的地址都是`192.168`网段，都是私有ip地址，它是怎么跟外网交互数据的呢，这里就引出来一个知识点叫`网络地址转换NAT`。

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f6472b9705984e698faf0e40947ebbfa~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

如上图所示，`192.168.0.3`，`192.168.0.4`都是私有网段上的，它们无法跟外网通信，这个时候由于路由器安装了NAT软件，就可以将自己的ip地址，即路由器的ip地址`172.38.1.5`作为内网的代理，去访问外网，外网返回来的数据，经过路由转换，转换成内网的`192.168`网段的私有地址。

#### 子网和子网掩码

首先要明白，为什么要划分子网？

> 首先大家要知道： 总体来说，划分子网不但没有增加可用IP地址，而且减少了可用IP地址，因为每个子网中的全0网络地址和全1广播地址均不能作为主机ip来使用。

为什么划分子网：

- 例如，一个A类网络可以容纳16777214台主机。
- 但是在实际运用中，不可能把一个A类网络只用于一个子网，因为那样管理起来很不方便，也会出现广播风暴等种种问题，所以需要根据实际需求把它划分为若干个较小的子网。一个B类网络可以容纳65534台主机，往往也是需要划分子网的。
- 即便一个小型企业内部，为了部门之间的职能的需要，配置那些电脑可以互相访问，哪些不能互相访问，就需要通过划分子网的方法来实现。

接下来，我们看看子网划分

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eb1926d05ae143a9a6ecfffaa3b730da~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

如上图右侧，我们将`145.13.0.0`这个网段划分了三个子网，其中一个是`145.13.3.0`，一个是`145.13.21.0`，问题来了，如果一个网络包来了，网络包要交给的ip地址是`145.13.3.10`，我们怎么知道给哪个子网呢？

方法是将目的包的ip地址，跟子网的`子网掩码`相与预算（二进制与预算规则是，1跟1得1，其它为0），也就是目的地址`145.13.3.10`跟子网`145.13.3.0`的子网掩码`255.255.255.0`的与预算，得到的结果是`145.13.3.0`，所以发送到的子网就是`145.13.3.0`。



### 协议

#### ARP 协议

我们简单回顾一下以太网的帧的格式

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cb1df8b2dc0b4832a9cf2c2da4b988aa~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) 上图有一个`源地址`和`目的地址`，这两个地址都是指的`mac地址`，`mac地址`是什么呢？简单说来就是两台相邻的路由器A和B，A怎么把数据传给B呢，它总要知道B的物理地址吧，物理地址就像`门牌号`一样，我要知道你住在哪里，才能把数据送过去吧？

首先你肯定知道自己的mac地址是多少，因为在网卡上有，问题在于，别人的`mac地址`是多少？`ARP协议`就是来帮你找`mac地址`的。

过程：

* 每台主机都会在自己的ARP缓冲区中建立一个 `ARP列表`，以表示`IP地址`和`MAC地址`的映射关系
* 当源主机需要将一个数据包要发送到目的主机时，会首先检查自己 `ARP列表`中是否存在该` IP地址`对应的`MAC地址`
* 如果有，就直接将数据包发送到这个`MAC地址`；如果没有，就向本地网段发起一个`ARP请求`的广播包，查询此目的主机对应的`MAC地址`
* 此`ARP请求`数据包里包括`源主机的IP地址`、`硬件地址`、以及`目的主机的IP地址`。网络中所有的主机收到这个`ARP请求`后，会检查数据包中的目的IP是否和自己的IP地址一致

* 如果不相同就忽略此数据包；如果相同，该主机首先将发送端的`MAC地址`和`IP地址`添加到自己的`ARP列表`中

* 如果`ARP表`中已经存在该IP的信息，则将其覆盖，然后给源主机发送一个 `ARP响应`数据包，告诉对方自己是它需要查找的`MAC地址`

* 源主机收到这个`ARP响应`数据包后，将得到的目的主机的`IP地址`和`MAC地址`添加到自己的`ARP列表`中，并利用此信息开始数据的传输

* 如果源主机一直没有收到`ARP响应`数据包，表示`ARP查询失败`

![image-20220902162206966](https://candy-picture.oss-cn-hangzhou.aliyuncs.com/img/202210252213038.png)

ARP 协议只能在一段链路或一个网络上使用，不能跨网络使用

#### DHCP 协议

DHCP（动态主机配置协议）是一个局域网的网络协议。指的是由服务器控制一段lP地址范围，客户机登录服务器时就可以自动获得服务器分配的lP地址和子网掩码。说白了，当你接入局域网的时候，自动由这个dhcp服务器给你分配ip，windows用户可能知道网卡配置里面，由自动获取ip的功能，如果路由器提供DHCP服务，你就会自动获取随机分配的ip。

#### ICMP 协议

`IP协议并不提供可靠传输`。如果丢包了，IP协议并不能通知传输层是否丢包以及丢包的原因。

所以我们就需要一种协议来完成这样的功能，即ICMP协议，来确认 IP 包是否成功到达目标地址。

* 主机或路由器使用ICMP来发送差错报告报文和询问报文
* ICMP报文被封装在IP数据报中发送。

以下是4种常见的ICMP差错报告报文 ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1652ee650ae44475834d5b8e195ffb47~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

我们常用的`ping`命令借助`ICMP协议`，探测主机是否能找到目的主机。







## 传输层

**功能：**为**端到端**提供可靠的 / 不可靠的传输服务，为端到端连接提供流量控制、差错控制、服务质量、数据传输管理等服务。传输单位是报文段 (TCP) 或者用户数据报 (UDP)。



### 端口号

端口号可以用来标识同一个主机上通信的不同应用程序（就是哪个应用程序在使用这个端口）。

那为什么一个端口只能分配给一个应用程序，不能是多个呢？

如果服务器有两个应用程序`A，B`，分别启动了A服务和B服务，它们监听同一个端口，那有数据来的时候，服务器无法判断这个数据到底是给A，还是给B。



### UDP 协议

UDP协议是参考模型中一种`无连接`的传输层协议，提供面向事务的简单不可靠信息传送服务。

**特点：**

* UDP是`无连接的`，减少开销和发送数据之前的时间延迟。大家都知道`TCP`的`三次握手和四次分手`，这个是需要时间花销的，但是UDP没有这部分花销。
* UDP使用`最大努力交付`，即不保证可靠交付。那谁来保证可靠的交付呢？是由UDP的上一层协议，应用层来保证。
* UDP是`面向报文的`，适合一次性传输少量数据的网络应用。什么意思呢，如下图，UDP这层，把应用层的全部内容作为自己的数据报部分，在IP层也只是加了一个IP首部，我们知道，在以太网，链路层上的数据如果超过1500字节，就会分片，所以网络层发现上面传输层给了`太大的数据就会分片`，加上UDP是不可靠的协议，这就加大了UDP的`不可靠性`，容易丢失，所以UDP适合数据量少的。 ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5c14babf66f04893a3096b21bc603ca4~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)
* UDP没有拥塞控制，适合很多实时应用。也就是说如果网络堵塞，UDP不管那么多，照样按照自己的速率发数据，那有些人就会说，这协议是不是有点坑B，路都堵上了，还发死劲发数据呢，但是反过来看，这也是UDP的优点，它允许丢包，如果你的网络情况还不错，UDP就非常适合实时应用，比如视频会议。
* UDP首部较小，只有8字节，而TCP由20字节。这也是`减少网络传输开销`的一方面。



### TCP 协议

TCP协议简单来说是一种位于传输层的，面向连接的、可靠的、基于字节流的传输层通信协议

**特点：**

* TCP是`面向连接`的传输层协议。比如说TCP的三次握手，四次挥手，针对的都是连接。
* 每一条TCP连接`只能有两个端点`，每一条TCP连接是点对点的。`也就是说TCP是不同计算机之间的进程的通信`。
* TCP提供可靠交付的服务，无差错，不丢失，不重复，按序到达。总结一下就是，`可靠有序，不丢不重`。
* TCP提供`全双工通信`。全双工指的是连接双方可以同时收发数据。在收发两端都有发送缓存和接收缓存，发送缓存就是一个准备发送的队列，接收缓存是一个准备接收的队列。
* TCP`面向字节流`。如下图，我们解释一下什么是面向字节流： ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/916849e0e9924da29a55401919883788~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp) 图中的1，2，3，4.....数据块，每一个表示一个字节。tcp将应用层的数据变为了这样的字节进行发送，比如玩过node同学，知道一个buffer，buffer就是字节流。



#### TCP 报文

如下图所示，我们看一下比较重要的一些首部字段，这里我们介绍`固定的20字节`的TCP首部 ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/334dcc7b195c40bf90fa747705deb9cc~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

- 源端口和目的端口分别是指发送方应用程序的端口和目的方应用程序的端口号。
- 序号是指在一个TCP连接中传送的字节流中的每一个字节都按顺序编号，本字段表示本报文段所发送数据的第一个字节的序号。
- 确认号是指期望收到对方下一个报文段的第一个数据字节的序号。若确认号为n，则证明到需要N-1为止所有的数据都已经正确收到。如下图，我们举例说明一下

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c05e6303c434441082dd5399996c2465~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

接收方收到了1，2，3个字节组成的数据包，然后接收方就会发送一个确认报文给发送方，其中确认报文的确认号就应该是4，因为1，2，3这三个字节的组成的数据包已经收到了。

- 数据偏移指的是TCP报文段的数据起始处举例TCP报文段的起始处有多远。
- 6个控制位介绍如下

| 控制位 | 作用                                                         |
| ------ | ------------------------------------------------------------ |
| ACK    | 置1时表示确认号合法，为0的时候表示数据段不包含确认信息，确认号被忽略 |
| PSH    | 置1时请求的数据段在接收方得到后就可直接送到应用程序，而不必等到缓冲区满时才传送 |
| RST    | 置1时重建连接。如果接收到RST位时候，通常发生了某些错         |
| SYN    | 置1时用来发起一个连接                                        |
| FIN    | 置1时表示发端完成发送任务。用来释放连接，表明发送方已经没有数据发送了 |
| URG    | 紧急指针，告诉接收TCP模块紧要指针域指着紧要数据              |

#### TCP 建立连接

如下图所示，分别来了解一下建立连接的过程： ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc6bd0c4f0264ffcb426c5632903ed9d~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

- 首先客户端要发送一个数据包告诉服务器要建立连接，根据上面我们了解到的控制位信息，建立连接需要把`SYN置为1`，`seq`指的是序号，是随机产生的。
- 然后服务器收到该数据包后，会为该TCP连接`分配缓存和变量`，缓存指的是一个字节流队列。（发送方和接收方都有这个队列，而且如果双方需要互相通信，那么双方都会有发送缓存和接收缓存），接着会返回一个确认报文，其中`SYN控制位置为1`，意思是允许建立连接，`ACK是确认号`，确认收到了发送方的包，并且会设一个`seq序号`，也为一个随机数。`小写ack`是确认号，也就是接下来希望发送方要发的数据从哪开始。
- 最后，客户端需要给服务器端返回一个确认，此时`SYN控制位变为0`，意思这不是建立连接的请求了，要正式发数据了，`ACK是确认码`，意思是收到了服务器的确认请求了。

#### TCP 释放连接

如下图所示，分别来了解一下释放连接的过程： ![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ad9322a88a5c4b529b553b4f5d5efbe7~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

- 客户端发起请求，请求断开链接。`FIN=1，seq=u`。u是之前传送过来的`最后一个字节的序号+1`。

> FIN：用来释放一个链接，当FIN=1的时候，表明此报文的发送方已经完成了数据的发送，没有新的数据要传送，并要求释放链接。 客户端等着服务器返回确认

- 服务器收到客户端的请求断开链接的报文之后，返回确认信息。`ACK=1，seq=v，ack=u+1`。这个时候，客户端不能给服务器发送信息报文，只能接收。但是服务器要是还有信息要传给服务器，仍然能传送。这里的`v`是什么意思呢，这就取决于服务器发送给客户端之前的一个包确认号是多少了。
- 当服务器也没有了可以传的信息之后，给客户端发送请求结束的报文。`FIN=1，ACK=1，ack=u+1，seq=w`。这里的`w`，跟上面的`v`是一个意思，为什么不都是`v`呢，因为这一步和上一步中间可能还在发数据呢，所以`seq`这个数据发送的字节流序号可能要变。
- 客户端接收到`FIN=1`的报文之后，返回确认报文，`ACK=1，seq=u+1，ack=w+1`。发送完毕之后，客户端进入等待状态，等待两个时间周期。关闭。

> 为什么最后还要等待两个时间周期呢？

- 客户端的最后一个`ACK`报文在传输的时候丢失，服务器并没有接收到这个报文。这个候时候服务器就会超时重传这个`FIN`消息，然后客户端就会重新返回最后一个`ACK报文`，等待两个时间周期，完成关闭。
- 如果不等待这两个时间周期，服务器重传的那条消息就不会收到。服务器就因为接收不到客户端的信息而无法正常关闭。

#### TCP 可靠传输

主要通过以下四种方式实现可靠传输机制：

- 校验。伪首部是为了增加TCP校验和的检错能力：通过伪首部的目的IP地址来检查TCP报文是否收错了、通过伪首部的传输层协议号来检查传输层协议是否选对了。需要注意的是，伪首部实际上是不存在的，只是用来验证TCP报文是否出错。
- 序号。之前我们提到TCP是面向字节流的，比如第一个字节就是序号1，第二个字节就是序号2。 而在TCP报文格式介绍的时候，有一个序号字段，这个指的是一个报文段第一个字节的序号。报文段就是你每个数据包。有了序号，就能保证数据是有序的传入应用层。
- 确认。发送方在收到接收方的确认包之后，才继续发送剩下的数据。
- 重传。TCP的发送方在规定的时间内没有收到确认就要重传已发送的报文段（超时重传）。重传时间是动态改变的，依据的是RTTS（加权平均往返时间）。

#### TCP 流量控制

- TCP 中采用滑动窗口来进行传输控制，`滑动窗口的大小意味着接收方还有多大的缓冲区可以用于接收数据`。发送方可以通过滑动窗口的大小来确定应该发送多少字节的数据。
- 当滑动窗口为 `0 `时，发送方一般`不能再发送数据报`，但有两种情况除外，一种情况是可以发送紧急数据，例如，允许用户终止在远端机上的运行进程。另一种情况是发送方可以发送一个 1 字节的数据报来通知接收方重新声明它希望接收的下一字节及发送方的滑动窗口大小。

#### TCP 拥塞控制

* 慢开始：
  * 维护一个拥塞窗口值 cwnd = 1
  * 维护一个拥塞窗口门限 ssthresh，当 cwnd < ssthresh 时指数增长，大于时线性增长
* 拥塞避免：当发生超时时，ssthresh 更新为 cwnd / 2，重新开始慢开始算法
* 快重传：每次收到之后都会发送对这次的确认，如果报文段丢失，就会一直发送该报文段的确认，如果收到三个重复确认，那么可以知道报文段丢失，此时执行快重传，立即重传报文段，不进行超时等待
* 快恢复：丢失个别报文段，不是网络拥塞，恢复时 cwnd = ssthresh

![image-20220913161550518](https://candy-picture.oss-cn-hangzhou.aliyuncs.com/img/202210252213508.png)







## 应用层

**功能：**为特定类型的网络应用提供访问OSI参考模型环境的手段。传输单位是报文。

**任务：**

- 区分是发送报文还是接收报文
- 定义报文类型的语法，比如某字段的意思，例如http中content-type字段是什么意思。
- 最后就是进程如何，什么时候把传输层的数据交给应用层。

**协议：**

 - DNS:将域名转换为ip地址
 - FTP:用于ftp客户端和ftp服务器之间进行文本、文件传输
 - SMTP:提供可靠且有效的电子邮件传输的协议
 - HTTP:规定了浏览器和服务器之间请求和响应的格式与规则
 - HTTPS:在Http和Tcp之间加入SSL/TLS协议，对传输信息进行加密



### DNS

> 什么是DNS说白了就是将域名转化为ip，比如www.qq.com，这是域名，可以是网络包需要对方ip地址，域名是不能加入网络包报头的，所以就需要去找一个服务器问，qq的域名对应的ip是多少。

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/445331c021914140884f047bba7d1e1e~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0.awebp)

大概的通信过程如下：

- 用户主机上运行着`DNS`的客户端，就是我们的PC机或者手机客户端运行着DNS客户端了
- 浏览器将接收到的url中抽取出域名字段，就是访问的主机名，比如`http://www.baidu.com/`, 并将这个主机名传送给DNS应用的客户端
- DNS客户机端向DNS服务器端发送一份`查询报文`，报文中包含着要访问的`主机名字段`（中间包括一些列缓存查询以及分布式DNS集群的工作）
- 该DNS客户机最终会收到一份`回答报文`，其中包含有该主机名对应的`IP地址`
- 一旦该浏览器收到来自DNS的IP地址，就可以向该IP地址定位的HTTP服务器发起TCP连接



### 万维网和 http 协议

> 万维网www是一个大规模的、联机式的信息存储所，是无数个网络站点和网页的集合。

知识盲区： 在不少人看来，互联网、因特网、万维网没有大多的区别，其实这三者之间的关系应该是：`互联网包含因特网，因特网包含万维网。`

- `互联网internet`。凡是由能彼此通信的设备组成的网络就叫互联网，即使仅有两台机器（计算机、手机等），不论用何种技术使其彼此通信，都叫互联网，所以，互联网有广域网、城域网及局域网之分，国际标准的互联网写法是internet，字母i一定要小写！
- `因特网Internet`。而因特网是互联网中的一种，它可不是仅有两台机器组成的网络，而是由上千万台设备组成的网络（该网络具备很大的规模）。因特网使用`TCP/IP协议`让不同的设备可以彼此通信。但使用`TCP/IP协议`的网络并不一定是因特网，一个局域网也可以使用`TCP/IP协议`。
- 因特网是基于`TCP/IP协议`实现的，`TCP/IP协议`由很多协议组成，不同类型的协议又被放在不同的层，其中，位于应用层的协议就有很多，比如`FTP、SMTP、HTTP`。所以，因特网提供的服务一般包括有：`www（万维网）服务、电子邮件服务（outlook）、远程登录（QQ）服务、文件传输（FTP）服务、网络电话`等等。
- `万维网`。只要应用层使用的是HTTP协议，就称为`万维网(World Wide Web)`。之所以在浏览器里输入百度网址时，能看见百度网提供的网页，就是因为您的个人浏览器和百度网的服务器之间使用的是HTTP协议在交流。